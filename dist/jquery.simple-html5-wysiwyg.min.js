/*
 *  jquery.simple-html5-wysiwyg - v0.3.0
 *  Simple jQuery WYSIWYG Plugin
 *  https://github.com/Iwark/jquery.simple-html5-wysiwyg
 *
 *  Made by Iwark <iwark02@gmail.com>
 *  Under MIT License
 */
(function(){var a,b;a=function(){function a(a,d){var e;this.source=a,this.settings=$.extend({},c,d),this.toolbar=new b(this.settings.commands,this.settings.bootstrap),e=this.settings.bootstrap?" form-control":"",this.$article=$("<article class='sh5wysiwyg-article"+e+"' contentEditable='true'>"+$(this.source).val()+"</article>"),this.init()}var c;return c={bootstrap:!1,commands:["font-size","bold","color","background-color","underline","link","border","image","movie","source"],minFontSize:12,maxFontSize:20,imageUploadTo:""},a.prototype.init=function(){return $(this.source).hide(),$(this.source).before($(this.toolbar.element)),$(this.source).before(this.$article),this.$article.html().length>0?this.convertMovieToThumb():void 0},a.prototype.setSourceVal=function(){return $(this.source).val(this.$article.html()),this},a.prototype.setEditorVal=function(){return this.$article.html($(this.source).val()),this},a.prototype.convertThumbToMovie=function(){var a,b;return a=$("<div>"+$(this.source).val()+"</div>"),b=this,a.find("img.sh5wysiwyg-niconico-thumb").each(function(){var a,c;return c=$(this).data("url"),a=b.getNiconicoMovie(c),$(this).replaceWith(a)}),a.find("img.sh5wysiwyg-youtube-thumb").each(function(){var a,c;return c=$(this).data("youtube-id"),a=b.getYoutubeMovie(c),$(this).replaceWith(a)}),$(this.source).val(a.html())},a.prototype.convertMovieToThumb=function(){var a,b;return a=$("<div>"+this.$article.html()+"</div>"),b=this,a.find('div[name="wysiwyg-insert-niconico-movie"]').each(function(){var a,c;return c=$(this).find("noscript").html().match(/href="(.*?)"/)[1],a=b.getNiconicoThumbImg(c),$(this).replaceWith(a)}),a.find("object.wysiwyg-youtube").each(function(){var a,c;return c=$(this).attr("data"),a=b.getYoutubeThumbImg(c),$(this).replaceWith(a)}),this.$article.html(a.html())},a.prototype.getNiconicoThumbImg=function(a){var b,c,d,e;return a.match(/^http:\/\/(?:www\.nicovideo\.jp\/watch|nico\.ms)\/[a-z][a-z](\d+)/)?(c=RegExp.$1,b=parseInt(c)%4+1,e="http://tn-skr"+b+".smilevideo.jp/smile?i="+c,d="<img class='sh5wysiwyg-niconico-thumb' style='width:425px; height:355px;' "+("src='"+e+"' data-url='"+a+"'>")):""},a.prototype.getNiconicoMovie=function(a){var b,c;return c=a.replace("watch","thumb_watch").replace("www","ext"),b='<div name="wysiwyg-insert-niconico-movie">  \n  <script type="text/javascript" src="'+c+'"></script>\n  <noscript><a href="'+a+'"></a></noscript>\n</div>'},a.prototype.getYoutubeThumbImg=function(a){var b;return a.match(/youtube\.com\/.*?v(?:=|\/)(.*?)(\&|$)/)||a.match(/youtu\.be\/(.*?)(\&|$)/)?(b=RegExp.$1,"<img class='sh5wysiwyg-youtube-thumb' style='width:425px; height:355px;' "+("src='http://img.youtube.com/vi/"+b+"/1.jpg' data-youtube-id='"+b+"'>")):""},a.prototype.getYoutubeMovie=function(a){var b;return b='<object class="wysiwyg-youtube" width="425" height="355" type="application/x-shockwave-flash" data="http://www.youtube.com/v/'+a+'">\n  <param name="movie" value="http://www.youtube.com/v/'+a+'" />\n  <param value="http://www.youtube.com/v/'+a+'" name="movie" />\n  <param value="transparent" name="wmode" />\n  <param value="http://img.youtube.com/vi/'+a+'/1.jpg" name="wysiwyg-insert-youtube-flash"></param>\n</object>'},a.prototype.execCommand=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n;switch(m=document.getSelection(),g=m.toString().length>0,g&&(k=m.anchorNode.parentNode,l=k.nodeName.toLowerCase()),a){case"font-size":if(g)return e=parseInt(prompt("Font Size (1-7):")),document.execCommand("fontSize",!1,e),i=document.getSelection().anchorNode.parentNode,j=i.nodeName.toLowerCase(),f=Math.round((this.settings.maxFontSize-this.settings.minFontSize)/6*100)/100,h=this.settings.minFontSize+f*(e-1),this.$article.find("*[size]").removeAttr("size").css("font-size",h+"px");break;case"bold":if(g)return document.execCommand("bold",!1);break;case"color":if(g)if(d="font"===l?$(k).css("color"):"",c=prompt("Color:",d),""===c){if("font"===l)return $(k).css("color","")}else if(document.execCommand("foreColor",!1,c),i=document.getSelection().anchorNode.parentNode,j=i.nodeName.toLowerCase(),"font"===j)return $(i).removeAttr("color").css("color",c);break;case"background-color":if(g)return b=prompt("Background Color:",$(k).css("background-color")),""===b?$(k).css("background-color",""):document.execCommand("backColor",!1,b);break;case"underline":if(g)return document.execCommand("underline",!1);break;case"link":if(g)return n=prompt("URL:"),""===n?document.execCommand("unlink",!1):document.execCommand("createLink",!1,n);break;case"border":if(g)return $(k).css($(k).hasClass("sh5wysiwyg-frame")?{display:"block",border:"none",padding:0,margin:0}:{display:"inline-block",border:"1px solid #777",padding:"4px",margin:"4px"}),$(k).toggleClass("sh5wysiwyg-frame");break;case"image":return $(".sh5wysiwyg-file:first").trigger("click");case"movie":if((n=prompt("URL:",""))&&((n.match(/youtube\.com/)||n.match(/youtu\.be/))&&document.execCommand("insertHTML",!1,this.getYoutubeThumbImg(n)),n.match(/^http:\/\/(?:www\.nicovideo\.jp\/watch|nico\.ms)\/[a-z][a-z](\d+)/)))return document.execCommand("insertHTML",!1,this.getNiconicoThumbImg(n));break;case"source":return this.setSourceVal(),this.$article.hide(),$(this.source).show(),$('.sh5wysiwyg-toolbar > input[value="source"]').hide(),$('.sh5wysiwyg-toolbar > input[value="editor"]').show();case"editor":return this.setEditorVal(),$(this.source).hide(),this.$article.show(),$('.sh5wysiwyg-toolbar > input[value="editor"]').hide(),$('.sh5wysiwyg-toolbar > input[value="source"]').show()}},a}(),b=function(){function a(a,b){this.commands=a,this.bootstrap=b,this.element="<div class='sh5wysiwyg-toolbar'>",this.bootstrapBtn=this.bootstrap?" class='btn btn-default'":"",this.init()}return a.prototype.init=function(){var a,b,c,d;for(d=this.commands,b=0,c=d.length;c>b;b++)a=d[b],this.element+="<input type='button' value='"+a+"'"+this.bootstrapBtn+">","source"===a&&(this.element+="<input type='button' value='editor'"+this.bootstrapBtn+" style='display: none;'>");return $.inArray("image",this.commands)&&(this.element+="<input type='file' class='sh5wysiwyg-file' style='position: absolute; top: -50px; left: 0; width: 0; height: 0; opacity: 0; filter: alpha(opacity=0);'>"),this.element+="</div>"},a}(),function(b){var c;return c="sh5wysiwyg",b.fn[c]=function(d){return this.each(function(){return b(this).data(c)?void 0:(b(this).addClass(c),b(this).data(c,new a(this,d)))}),b(".sh5wysiwyg-article").off("focus.sh5").on("focus.sh5",function(){var a,c,d;return d=document.getSelection(),!b(this).html()&&(a=b("<div></div>"),b(this).html(a),c=document.createRange(),c.selectNode(a[0]),d.removeAllRanges(),d.addRange(c),b(this).html(""),document.execCommand("insertParagraph",!1,null),b(this).find("div").length>1)?b(this).find("div:first").remove():void 0}),b(".sh5wysiwyg-toolbar > input").off("click.sh5").on("click.sh5",function(){var a,d;return a=b(this).parent().nextAll("."+c+":first"),d=a.data(c),d.execCommand(b(this).val())}),b(".sh5wysiwyg-file").off("change.sh5").on("change.sh5",function(a){var c;if(!(document.getSelection().toString().length>0))return a.preventDefault(),c=new FormData,c.append("file",this.files[0]),b.ajax({url:d.imageUploadTo,type:"POST",data:c,processData:!1,contentType:!1,dataType:"json",success:function(a){return document.execCommand("insertImage",!1,a.url)},error:function(a,b,c){return alert("Error textStatus:"+b+", errorThrown:"+c)}})}),b("."+c).parents("form").off("submit.sh5").on("submit.sh5",function(){return b("."+c).each(function(){return b(this).data(c).setSourceVal().convertThumbToMovie()})})}}(jQuery)}).call(this);